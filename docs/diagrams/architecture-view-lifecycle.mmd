%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#1e1e1e',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#ffffff',
    'lineColor': '#ffffff',
    'secondaryColor': '#2d2d2d',
    'tertiaryColor': '#1e1e1e',
    'noteBkgColor': '#2d2d2d',
    'noteTextColor': '#ffffff',
    'noteBorderColor': '#ffffff'
  }
}}%%
graph TB
    subgraph ViewEngineLoop["View Engine Event Loop (tokio::select!)"]
        direction TB
        
        Start["Start ViewEngine"]
        Render["Render View<br/>(handler.render)"]
        Select["tokio::select!"]
        
        Component["Component Interaction<br/>(Discord UI)"]
        Async["Async Event<br/>(ctx.spawn / tx.send)"]
        Modal["Modal Submission"]
        Timeout["Timeout Event"]
        
        TriggerNode["Map to Trigger<br/>+ Action Enum"]
        Handle["ViewHandler::handle"]
        
        CmdRender["ViewCommand::Render"]
        CmdContinue["ViewCommand::Continue / AlreadyResponded"]
        CmdExit["ViewCommand::Exit"]
        
        Start -->|engine.run| Render
        Render -->|loop| Select
        
        Select -->|ComponentInteraction| Component
        Select -->|mpsc::recv| Async
        Select -->|ModalSubmit| Modal
        Select -->|Collector Timeout| Timeout
        
        Component & Async & Modal & Timeout -->|Trigger::from| TriggerNode
        TriggerNode -->|handler.handle| Handle
        
        Handle -->|return| CmdRender
        Handle -->|return| CmdContinue
        Handle -->|return| CmdExit
        
        CmdRender -->|re-render| Render
        CmdContinue -->|next event| Select
        CmdExit -->|break| Stop[Stop Engine]
    end
    
    subgraph Mapping["Context & Delegation"]
        direction TB
        ParentCtx["Parent ViewContext"]
        Map["ctx.map(Wrap)"]
        ChildCtx["Child ViewContext"]
        
        ParentCtx --> Map
        Map --> ChildCtx
    end
    
    Mapping -.->|provides| Handle
    
    style Start fill:#2d2d2d,stroke:#ffffff,stroke-width:2px
    style Stop fill:#2d2d2d,stroke:#ffffff,stroke-width:2px
    style Render fill:#1e1e1e,stroke:#ffffff
    style Select fill:#1e1e1e,stroke:#ffffff
