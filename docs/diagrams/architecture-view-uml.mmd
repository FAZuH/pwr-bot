%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#1e1e1e',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#ffffff',
    'lineColor': '#888888',
    'secondaryColor': '#2d2d2d',
    'tertiaryColor': '#1e1e1e'
  }
}}%%
classDiagram
    %% ── Core structs ──────────────────────────────────────────────
    class ViewContext {
        poise_ctx: Context
        timeout: Duration
        reply_handle: Option~ReplyHandle~
        message_id() Option~MessageId~
    }

    class ActionRegistry~T~ {
        actions: HashMap~String, T~
        prefix: String
        counter: usize
        register(action: T) String
        get(id: str) Option~T~
        ids() Vec~str~
        clear()
    }

    class ViewCore~T~ {
        ctx: ViewContext
        registry: ActionRegistry~T~
        send(reply) Result
        edit(reply) Result
    }

    class RegisteredAction {
        id: String
        label: str
        as_button() CreateButton
        as_select(kind) CreateSelectMenu
        as_select_option() CreateSelectMenuOption
    }

    class Coordinator~S~ {
        ctx: Context
        state: S
        send(reply) Result
        edit(reply) Result
        context() Context
    }

    class NavigationResult {
        <<enum>>
        SettingsMain
        SettingsFeeds
        SettingsVoice
        SettingsAbout
        Back
        Exit
        FeedList
        FeedSubscribe
        FeedUnsubscribe
        VoiceLeaderboard
        VoiceStats
    }

    %% ── Traits ────────────────────────────────────────────────────
    class View~T~ {
        <<trait>>
        core() ViewCore~T~
        core_mut() ViewCore~T~
    }

    class ResponseView {
        <<trait>>
        create_response() ResponseKind
        create_reply() CreateReply
    }

    class RenderExt {
        <<trait>>
        render() Result
    }

    class InteractiveView~T: Action~ {
        <<trait>>
        handle(action, interaction) Option~T~
        on_timeout() Result
        listen_once() Result~Option~(T, ComponentInteraction)~~
        register(action) RegisteredAction
        children() Vec~ChildViewResolver~T~~
    }

    class Action {
        <<trait>>
        label() str
    }

    class Controller~S~ {
        <<trait>>
        run(coord: Coordinator~S~) Result~NavigationResult~
    }

    %% ── Trait relationships ───────────────────────────────────────
    View <|-- ResponseView
    View <|-- InteractiveView
    ResponseView <|-- RenderExt : blanket impl
    InteractiveView ..> Action : bound
    InteractiveView ..> RegisteredAction : produces
    ViewCore *-- ViewContext
    ViewCore *-- ActionRegistry
    Coordinator ..> Controller : drives
    Controller ..> NavigationResult : returns

    %% ── Concrete views ───────────────────────────────────────────
    class PaginationView {
        core: ViewCore~PaginationAction~
        state: PaginationModel
        disabled: bool
    }

    class SettingsMainView {
        core: ViewCore~SettingsMainAction~
        guild_id: GuildId
    }

    class SettingsFeedView {
        core: ViewCore~SettingsFeedAction~
        guild_id: GuildId
        feed: Option~FeedConfig~
        form: FeedForm
    }

    class SettingsVoiceView {
        core: ViewCore~SettingsVoiceAction~
        guild_id: GuildId
        config: VoiceConfig
    }

    class VoiceLeaderboardView {
        core: ViewCore~VoiceLeaderboardAction~
        guild_id: GuildId
        data: Vec~VoiceStats~
        pagination: PaginationView
    }

    class VoiceStatsView {
        core: ViewCore~VoiceStatsAction~
        user_id: UserId
        guild_id: GuildId
        range: VoiceStatsTimeRange
    }

    class FeedListView {
        core: ViewCore~FeedListAction~
        guild_id: GuildId
        feeds: Vec~Feed~
        pagination: PaginationView
    }

    class FeedSubscriptionBatchView {
        core: ViewCore~FeedSubscriptionBatchAction~
        guild_id: GuildId
        url: String
        feeds: Vec~DetectedFeed~
    }

    class SettingsNavigationView {
        core: ViewCore
        sections: Vec~SettingsSection~
    }

    InteractiveView <|.. PaginationView
    InteractiveView <|.. SettingsMainView
    InteractiveView <|.. SettingsFeedView
    InteractiveView <|.. SettingsVoiceView
    InteractiveView <|.. VoiceLeaderboardView
    InteractiveView <|.. VoiceStatsView
    InteractiveView <|.. FeedListView
    InteractiveView <|.. FeedSubscriptionBatchView
    ResponseView <|.. SettingsNavigationView

    %% ── Controllers ──────────────────────────────────────────────
    Controller <|.. SettingsMainController
    Controller <|.. FeedSettingsController
    Controller <|.. VoiceSettingsController
    Controller <|.. FeedListController
    Controller <|.. FeedSubscribeController
    Controller <|.. FeedUnsubscribeController
    Controller <|.. VoiceLeaderboardController
    Controller <|.. VoiceStatsController
    Controller <|.. AboutController

    note for View "view_core! macro generates impl"
    note for Action "action_enum! macro generates impl"
