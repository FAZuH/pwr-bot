%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#1e1e1e',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#ffffff',
    'lineColor': '#888888',
    'secondaryColor': '#2d2d2d',
    'tertiaryColor': '#1e1e1e'
  }
}}%%
classDiagram
    %% ── Core structs ──────────────────────────────────────────────
    class ViewContext {
        poise_ctx: Context
        timeout: Duration
        reply_handle: Option~ReplyHandle~
        message_id() Option~MessageId~
    }

    class ActionRegistry~T~ {
        actions: HashMap~String, T~
        prefix: String
        counter: usize
        register(action: T) String
        get(id: str) Option~T~
        ids() Vec~str~
        contains(id: str) bool
        clear()
    }

    class ViewCore~T~ {
        ctx: ViewContext
        registry: ActionRegistry~T~
        send(reply) Result
        edit(reply) Result
    }

    class RegisteredAction {
        id: String
        label: str
        as_button() CreateButton
        as_select(kind) CreateSelectMenu
        as_select_option() CreateSelectMenuOption
    }

    class InteractiveViewBase~T~ {
        core: ViewCore~T~
        should_acknowledge: bool
        listen_once(handler) Result~Option~(T, ComponentInteraction)~~
        register(action: T) RegisteredAction
    }

    class Coordinator~S~ {
        ctx: Context
        state: S
        context() Context
        state() S
        state_mut() S
    }

    class NavigationResult {
        <<enum>>
        SettingsMain
        SettingsFeeds
        SettingsVoice
        SettingsAbout
        FeedSubscriptions
        FeedSubscribe
        FeedUnsubscribe
        FeedList
        VoiceLeaderboard
        Back
        Exit
    }

    class ViewCommand {
        <<enum>>
        Render
        Exit
    }

    %% ── Traits ────────────────────────────────────────────────────
    class View~T~ {
        <<trait>>
        core() ViewCore~T~
        core_mut() ViewCore~T~
    }

    class ResponseView {
        <<trait>>
        create_response() ResponseKind
        create_reply() CreateReply
    }

    class RenderExt {
        <<trait>>
        render() Result
    }

    class Action {
        <<trait>>
        label() str
    }

    class ViewHandler~T: Action~ {
        <<trait>>
        handle(action: T, interaction: ComponentInteraction) Option~T~
        on_timeout() Result
        children() Vec~ChildViewResolver~T~~
    }

    class ChildViewResolver~T~ {
        <<trait>>
        filter_ids() Vec~String~
        resolve(custom_id: str) Option~T~
        clear()
    }

    class InteractiveView~T: Action~ {
        <<trait>>
        handler() ~mut Self::Handler~
        run(on_action) Result
    }

    class Controller~S~ {
        <<trait>>
        run(coordinator: Coordinator~S~) Result~NavigationResult~
    }

    %% ── Trait relationships ───────────────────────────────────────
    View <|-- ResponseView
    View <|-- InteractiveView
    ResponseView <|-- RenderExt : blanket impl
    InteractiveView ..> Action : bound
    InteractiveView ..> ViewHandler : bound
    InteractiveView ..> RegisteredAction : produces
    InteractiveViewBase --> ViewCore
    ViewCore *-- ViewContext
    ViewCore *-- ActionRegistry
    Coordinator ..> Controller : drives
    Controller ..> NavigationResult : returns

    %% ── Concrete implementations ───────────────────────────────────
    class PaginationView {
        core: ViewCore~PaginationAction~
        state: PaginationModel
        disabled: bool
    }

    InteractiveView <|.. PaginationView

    note for View "view_core! macro generates impl"
    note for Action "action_enum! macro generates impl"
