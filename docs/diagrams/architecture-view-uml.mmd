%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#1e1e1e',
    'primaryTextColor': '#ffffff',
    'primaryBorderColor': '#ffffff',
    'lineColor': '#888888',
    'secondaryColor': '#2d2d2d',
    'tertiaryColor': '#1e1e1e'
  }
}}%%
classDiagram
    %% ── Core structs ──────────────────────────────────────────────
    class ViewContext~T~ {
        poise: Context
        tx: Arc~dyn ViewSender~T~~
        map(wrap) ViewContext~C~
        spawn(future)
    }

    class ActionRegistry~T~ {
        actions: HashMap~String, T~
        prefix: String
        counter: usize
        register(action: T) String
        get(id: str) Option~T~
        clear()
    }

    class ViewEngine~T, H~ {
        ctx: Context
        handler: H
        registry: ActionRegistry~T~
        timeout: Duration
        should_acknowledge: bool
        render_view() Result
        run(on_action) Result
    }

    class RegisteredAction {
        id: String
        label: str
        as_button() CreateButton
        as_select(kind) CreateSelectMenu
        as_select_option() CreateSelectMenuOption
    }

    class Coordinator~S~ {
        ctx: Context
        state: S
        context() Context
        state() S
        state_mut() S
    }

    class NavigationResult {
        <<enum>>
        Back
        Exit
        SettingsMain
        ...
    }

    class ViewCommand {
        <<enum>>
        Render
        Exit
        Continue
        AlreadyResponded
    }

    class Trigger {
        <<enum>>
        Component
        Modal
        Message
        Async
        Timeout
    }

    %% ── Traits ────────────────────────────────────────────────────
    class Action {
        <<trait>>
        label() str
    }

    class ViewRender~T: Action~ {
        <<trait>>
        render(registry) ResponseKind
        create_reply(registry) CreateReply
    }

    class ViewHandler~T: Action~ {
        <<trait>>
        handle(action, trigger, ctx) Result~ViewCommand~
        on_timeout() Result
    }

    class Controller~S~ {
        <<trait>>
        run(coordinator: Coordinator~S~) Result~NavigationResult~
    }

    %% ── Trait relationships ───────────────────────────────────────
    ViewEngine --> ViewHandler : owns
    ViewEngine --> ViewRender : owns
    ViewEngine --> ActionRegistry : owns
    ViewHandler ..> ViewCommand : returns
    ViewHandler ..> Trigger : receives
    ViewHandler ..> ViewContext : receives
    ActionRegistry ..> Action : maps
    ActionRegistry ..> RegisteredAction : produces
    Coordinator ..> Controller : drives
    Controller ..> NavigationResult : returns
